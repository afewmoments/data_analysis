---
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Подготовка данных

В анализе будут использоваться следующие пакеты
```{r}
library(tidyverse)
library(lubridate) # Для парсинга даты
library(scales)    # Для скэйлов осей в деньги
```

Импорт исходных данных

```{r}
movie_profit_raw <- read_csv("movie_profit.csv")
```

Приводим исходные данные к аккуратному виду
```{r}
movie_profit <- movie_profit_raw %>%
  # избавимся от первого столбца потому что это не информативный столбец
  select(-X1) %>%
  # дата сохранена как текст, распарсим её для корректного отображения
  mutate(release_date = as.Date(parse_date_time(release_date, "%m!/%d/%Y"))) %>%
  # будем изучать только фильмы, вышедшие до начала 2018 года
  filter(release_date < "2018-01-01") %>%
  arrange(desc(row_number())) %>%
  distinct(movie, release_date, .keep_all = TRUE) %>%
  # предположим, что самые большие бюджеты на производство сконцентрированы в руках нескольких компаний, допустим 6
  mutate(distributor = fct_lump(distributor, n = 6)) %>%
  # отфильтруем фильмы с нулевыми кассовыми сборами, вероятно они не вышли
  filter(worldwide_gross > 0) %>%
  # добавим коэффициент окупаемости, объясняется ниже
  mutate(profit_ratio = worldwide_gross / production_budget)
```

###  Сколько денег затрачивается на производство?

Посмотрим сколько обычно тратится денег на производство одного фильма
```{r}
# для начала посмотрим сколько фильмов производят компании.
movie_profit %>% 
  count(distributor, sort = TRUE)
# шесть компаний производят столько же фильмов, сколько все оставшиеся компании

movie_profit %>%
  ggplot(aes(production_budget)) +
  geom_histogram() +
  scale_x_log10(labels = dollar_format())
```

Построим ящики с усами, для наглядного отображения

```{r}
movie_profit %>%
  ggplot(aes(distributor, production_budget)) +
  geom_boxplot() +
  scale_y_log10(labels = dollar_format()) +
  coord_flip()
```

Можно добавить к шести лидирующим компаниям ещё парочку, но общая картина уже видна и так. 

* В данных есть фильмы, у которых не указаны производители (пропущенные значения). Их затраты на производство значительно меньше чем у остальных компаний.

* Все остальные компании тратят заметно меньше 6 лидирующих

Посмотрим как распределяются вознаграждения за фильм
```{r}
movie_profit %>%
  ggplot(aes(distributor, worldwide_gross)) +
  geom_boxplot() +
  scale_y_log10(labels = dollar_format()) +
  coord_flip()
```
В общем картина похожа на затраты.

### Какие жанры приносят больше всего прибыли

Какие вообще есть жанры?
```{r}
movie_profit %>%
  count(genre, sort = TRUE)
```

Всего шесть. Посмотрим какие затрты на производство в каждом разрезе.

```{r}
movie_profit %>%
  ggplot(aes(genre, production_budget)) +
  geom_boxplot() +
  scale_y_log10(labels = dollar_format()) +
  coord_flip()
```

Заметны различия, перераспределим жанры по увеличению бюджета

```{r}
movie_profit %>%
  mutate(genre = fct_reorder(genre, production_budget)) %>%
  ggplot(aes(genre, production_budget)) +
  geom_boxplot() +
  scale_y_log10(labels = dollar_format()) +
  coord_flip()
```

Самые большие затрыты на приключения, самые низкие на ужастики.

Какой наиболее встречаемый бюджет за всё время?

```{r}
movie_profit %>%
  # сгруппируем фильмы по декадам
  mutate(decade = 10 * floor(year(release_date) / 10)) %>%
  group_by(decade) %>%
  # посмотрим медианные значения по всем числовым характеристикам
  summarize_at(vars(production_budget:worldwide_gross), median, na.rm = TRUE) %>%
  # соберём все данные в таблицу, для удобного отображения
  gather(metric, value, -decade) %>%
  # посмотрим как декада к дакаде менялись затраты и окупаемость фильмов
  ggplot(aes(decade, value, color = metric)) +
  geom_line() +
  scale_y_log10(labels = dollar_format())
```

Посмотрим сколько компании тратят на производство каждого представленного жанра. Для этого рассмотрим ящики с усами по панелям, в зависимости от производителя

```{r}
movie_profit %>%
  mutate(genre = fct_reorder(genre, production_budget)) %>%
  filter(!is.na(distributor)) %>%
  ggplot(aes(genre, production_budget)) +
  geom_boxplot() +
  scale_y_log10(labels = dollar_format()) +
  coord_flip() +
  facet_wrap(~ distributor)
```

Интересная картина. К примеру видно что дисней не особо вкладывается в ужастики. Посмотрим что с кассовыми сборами

```{r}
movie_profit %>%
  mutate(genre = fct_reorder(genre, worldwide_gross)) %>%
  filter(!is.na(distributor)) %>%
  ggplot(aes(genre, worldwide_gross)) +
  geom_boxplot() +
  scale_y_log10(labels = dollar_format()) +
  coord_flip() +
  facet_wrap(~ distributor)
```

У всех компаний примерно стабильные доходы от выпуска фильма. Кроме "остальных" компаний. Длинный хвост и большое количество выбросов, говорит о том что многие фильмы не приносят ожидаемых доходов.

### Какие жанры имеют наибольшее вознаграждение

Посмотрим отношение кассовых международных сборов к производству фильмов. Для этого мы введём коэффициент окупаемости, который показываеты отношение денег полученных от продаж к затраченным на производство фильма. Чем дальше от единицы, тем большая окупаемость. Чем меньше единицы, тем провальнее были кассовые сборы.

```{r}
movie_profit %>%
  mutate(profit_ratio = worldwide_gross / production_budget) %>%
  arrange(desc(profit_ratio))
```

Взглянем на распределение коэффициента
```{r}
movie_profit %>%
  mutate(profit_ratio = worldwide_gross / production_budget) %>%
  arrange(profit_ratio) %>%
  ggplot(aes(profit_ratio)) +
  geom_histogram() +
  scale_x_log10()
```

Очень близко к нормальному. Посмотрим, как меняется коэффициент в зависимости от жанра


```{r}
movie_profit %>%
  mutate(profit_ratio = worldwide_gross / production_budget) %>%
  arrange(profit_ratio) %>%
  ggplot(aes(genre, profit_ratio)) +
  geom_boxplot() +
  scale_y_log10() +
  coord_flip()
```

Ящики показывают, что основная масса фильмов, укладываются между 0.1 и 10. Посмотрим какой средний коэффициент в зависимости от жанра

```{r}
movie_profit %>%
  mutate(profit_ratio = worldwide_gross / production_budget) %>%
  group_by(genre) %>%
  summarise(median_profit_ratio = median(profit_ratio)) %>%
  arrange(desc(median_profit_ratio))
```

Покажем это же распределение при помощи столбиков

```{r}
movie_profit %>%
  mutate(profit_ratio = worldwide_gross / production_budget) %>%
  group_by(genre) %>%
  summarise(median_profit_ratio = median(profit_ratio)) %>%
  arrange(desc(median_profit_ratio)) %>%
  mutate(genre = fct_reorder(genre, median_profit_ratio)) %>%
  ggplot(aes(genre, median_profit_ratio)) +
  geom_col() +
  coord_flip() +
  scale_y_continuous(labels = function(x) paste0(x, "x")) # Для наглядности, поменяем подписи оси, на соответствующее кратное увеличение
```

Отличный показатель. Давайте теперь рассмотрим как менялся этот показатель год от года в разных жанрах

```{r}
movie_profit %>%
  group_by(genre, year = year(release_date)) %>%
  summarise(median_profit_ratio = median(profit_ratio),
            movies = n()) %>%
  ungroup() %>%
  filter(year >= 2000) %>%
  arrange(desc(median_profit_ratio)) %>%
  ggplot(aes(year, median_profit_ratio, color = genre)) +
  geom_line() +
  scale_y_continuous(labels = function(x) paste0(x, "x"))
```

Интересная история у фильмов ужасов --- до примерно 2010 всё развивалось примерно как и в других жанрах. А потом произошёл необычный скачок. 
