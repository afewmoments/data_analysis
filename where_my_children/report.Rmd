---
title: "Тестовое задание на позицию Product analyst"
author: "С.А. Масюта"
date: "Март 2022"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---


# Библиотеки

```{r}
library(tidyverse)
```

# Подключение к БД

```{r}
connection <- DBI::dbConnect(
  RMySQL::MySQL(),
  host     = "191.96.43.4",
  dbname   = "analytics_test",
  user     = "analytics_test",
  password = "ds322loowe88zxcgJUs",
  port     = 3306)

#DBI::dbDisconnect(connection)
```


# Эксперимент 1 -- снижение цен на продукт с 400 у.е. до 160 у.е.


## Получение данных


```{r}
payment_query <- "
SELECT 
p.uid,
p.paymentType,
p.Payment,
e.Group
FROM Payment AS p
  LEFT JOIN (
  SELECT *
  FROM Experiments
  WHERE Experiment = 'paymentChange')  as e
  ON p.uid = e.uid;
"

payment <- DBI::dbGetQuery(connection, payment_query) %>% 
  as_tibble()

# привожу имена столбцов к snake_case
names(payment) <- snakecase::to_snake_case(names(payment))
```

## Гипотеза

Сформулируем предложенную гипотезу из задания в гипотезах для стат. проверки:

  * Нулевая гипотеза --- Если снизить цену на первый продукт с 400 у.е. до 160 у.е. это никак не скажется на продажах
  * Альтернативная гипотеза --- Если снизить цену на первый продукт с 400 у.е. до 160 у.е. это изменит продажи
  
### Оцениваемая метрика
  
Оценивать будем ARPU и Revenue в частности.

ARPU опрделяем как суммарный доход группы, разделённый на количество пользователей в группе

### Направленность теста

После уменьшении цены на один товар, ARPU и Revenue в общем случае может и упасть. Поэтому тесты необходимо делать двусторонними.


## EDA 

Изучим данные

### Сводная характеристика групп

```{r}
payment_summary <- payment %>% 
  group_by(group, uid) %>% 
  summarise(mean_payment = mean(payment),
            sum_payment = sum(payment), 
            .groups = "drop") %>%
  group_by(group) %>%
  summarise(user_count = n(),
            mean_payment = mean(mean_payment),
            mean_payment_sd = sd(sum_payment),
            revenue = sum(sum_payment),
            arpu = revenue/user_count)

payment_summary
```


В группе New почти в 1.4 а раза уменьшился ARPU, но при этом увеличилось кол-во покупателей и общий Revenue (менее чем на 1 процент). Дополнительно, стандартное отклонение значительно сократилось.


### Паттерны покупок пользователей

Пользователи могут приобрести как какой-то один товар (type1 или type2), так и два товара вместе (both).

Давайте изучим как изменился паттерн потребления, при уменьшении цены на товар 1

```{r}
payment %>% 
  pivot_wider(
    names_from = payment_type,
    values_from = payment,
    values_fill = 0) %>% 
  mutate(payment_type = ifelse(
    type1 !=0  & type2!=0,
    "both",
    ifelse(type1!=0, "type1", "type2")
  )) %>% 
  mutate(payment = type1 + type2) %>%
  group_by(group, payment_type) %>% 
  summarise(
    group_count = n(),
    group_mean = mean(payment),
    group_sum = sum(payment),
    .groups = "drop") %>% 
  pivot_longer(
    cols = c(group_count, group_sum),
    names_to = "metric",
    values_to = "value"
  ) %>% 
  ggplot(aes(value, payment_type)) +
  geom_col() +
  geom_label(aes(label = value),
              hjust = "inward") +
  facet_grid(group~metric, scales = "free_x") +
    labs(
      x = "",
      y = "Пользовательский паттерн покупок",
      title = "Разница паттернов покупок между группами New и Old",
      subtitle = "group_count в штуках, group_sum в рублях"
    )
```

В группе New самой многочисленной подгруппой пользователей была та, в которой покупали товар type1. Тогда как в группе Old, больше всего пользователей в группе type2. 

При этом изменился суммарный доход подгруппы. Если в группе Old самым прибыльным был type2, то в New больше всего продаж с подгруппы both.

### Распределение покупок

```{r}
payment %>% 
  group_by(group, uid) %>% 
  summarise(payment_sum = sum(payment), .groups = "drop") %>% 
  count(group, payment_sum) %>% 
  ggplot(aes(payment_sum, n)) +
  geom_col(position = "dodge") +
  facet_wrap(~group, nrow = 2) +
  labs(
    x = "Сумма платежа",
    y = "Размер подгруппы",
    title = "Распределение покупок по группам"
  )
```

Из графика выше можно сказать, что данные в группах не относятся к какому-то типичному распределению. У нас есть несколько «подгрупп», сформированных из фактических цен на услуги, вокруг которых и сформированы пользовательские покупки.

Исходя из этого нет необходимости делать проверки на нормальность выборки.

## Анализ результатов

Доход после изменения цены увеличился, а ARPU упал. Для того чтобы оценить значимо ли изменились показатели, оценим влияющие на ARPU исходную метрики. Основной  исходной метрикой для подобной оценки будет Revenue. 

Мы не будем сравнивать два средних между вариантами. Мы сравним два распределения продаж. Если доход на пользователя во всей выборке изменился статистически значимо, значит и изменение Revenue статистически значимо. 

### Выбор уровня значимости

Для выявления значимых отклонений в этом эксперименте будет достаточен уровень значимости \alpha = 0.05

### U-тест Манна-Уитни

Этот тест непараметрический, он нам в данном случае подходит, поскольку тест не предполагает какого-то конкретного распределения данных.

Если нулевая гипотеза для этого теста верна, т.е. между двух групп нет существенной разницы --- мы сможем сказать, что изменение цены статистически не значимо.

```{r}
payment_for_test <- payment %>% 
  group_by(group, uid) %>% 
  summarise(mean_payment = mean(payment),
            sum_payment = sum(payment), 
            .groups = "drop")
  
wilcox.test(mean_payment ~ group,
                   data = payment_for_test,
                   exact = FALSE,
                   alternative = "two.sided")
```

`p-value < 2.2e-16` что очень близко к нулю. Это позволяет нам отвергнуть нулевую гипотезу. Основываясь на этом заключаем, что распределение платежей по пользователям статистически значимо.

## Вывод по эксперименту 1

В ходе эксперимента мы установили, что в группе New существенно уменьшился ARPU. Однако при этом не сильно увеличился Revenue. 

Чтобы установить, значимо ли было изменение Revenue, мы провели исследование поведения обеих выборок, вместо сравнения средних.

На основании проведённого непараметрического U-теста Манна-Уитни, мы можем заключить, что изменение продаж было статистически значимо.

Поэтому предлагается оставить в сервисе вариант с уменьшением цены на продукта 1 с 400 у.е. до 160 у.е.

# Эксперимент 2 -- вынесение function2 в меню туда, где раньше была function1.

## Получение данных


```{r}
action_query <- "
SELECT 
a.uid,
a.Action,
a.Ts,
e.Group
FROM Action AS a
  LEFT JOIN (
  SELECT *
  FROM Experiments
  WHERE Experiment = 'actionChange')  as e
  ON a.uid = e.uid;
"

action <- DBI::dbGetQuery(connection, action_query) %>% 
  as_tibble() %>% 
  mutate(Ts = lubridate::as_datetime(Ts))

# привожу имена столбцов к snake_case
names(action) <- snakecase::to_snake_case(names(action))
```



## Гипотеза

Общую гипотезу из задания можно сформулировать так: «Если поменять расположение function2 в меню, туда где раньше была function1, это позитивно скажется на вовлечение пользователей в функции».

Сформулируем в гипотезах для стат. проверки:

  * Нулевая гипотеза --- Вынесение function2 на место function1, никак не отразится на вовлечении пользователей в функции
  * Альтернативная гипотеза --- Вынесение function2 в меню туда, где раньше была function1 изменит вовлечение пользователей в функции
  
### Оцениваемая метрика

Под вовлеченностью будем считать время, которое прошло между firstOpen и любым другим действием.

Логика в этом следующая:
  * чем быстрее пользователь после firstOpen начнёт выполнять действия завязанные на function%, тем быстрее он будет знакомиться с продуктом, тем с большей вероятностью в дальнейшем будет совершать целевые действия

Я заведомо буду считать время до первого действия с любым function%. Я исхожу из предположения, что изменение мест function1 и function2 между собой, может сделать для пользователя выполнение function3 или function4 более желанным или удобным.

Желанность или удобство, может быть связано допустим с тем, что после изменения положений function1 и function2, появилась ритмичность у всего набора function1...4 --- кнопки «рифмуются», кнопки стали в порядке убывания или возрастания, и т.п. Или напримерстраница стала в целом более гармоничная.


Выведем целевую метрику
```{r}
action_with_metric <- action %>% 
  arrange(uid, ts) %>%
  group_by(uid) %>% 
  # оставляем только первые две по таймингу группы
  mutate(row_id = row_number()) %>% 
  filter(row_id <= 2) %>% 
  ungroup() %>% 
  select(-action) %>% 
  pivot_wider(
    names_from = row_id,
    values_from = ts,
    names_prefix = "action"
  ) %>% 
  mutate(time_to_action = action2 - action1)
```

### Направленность теста

Логично предположить, что вовлечённость может как увеличиться, так и уменьшиться в результате внесённых изменений. Поэтому я буду проверять двустороннее распределение.
  
  
## EDA

### Как распределены группы в эксперименте
```{r}
action %>% 
  count(uid, group) %>% 
  count(group) %>% 
  mutate(rate = n/sum(n)) %>% 
  ggplot(aes(group, rate)) +
  geom_col() +
  geom_label(aes(label = paste0("Доля ", round(rate, 2),
                               "\n Кол-во ", n)),
            vjust = "inward") +
  labs(
    title = "Доля пользователей в экспериментальных группах",
    x = "группа",
    y = "доля пользователей"
  )
```

Вывод: Присутствует дисбаланс классов, в группе Old на одного пользователя больше.
Выборки для проведения тестов должны быть одного размера. Привести выборки к одинаковому размеру можно разными способами --- удалив наиболее близкий к среднему из большей выборки, или добавив среднее значение к меньшей выборки. 

Я сделаю допущение, что один пользователь ошибочно попал в группу. Поэтому мы исключим самого последнего пользователя из группы Old.


### Сколько действий выполняют пользователи в среднем
```{r}
action %>% 
  count(group, uid) %>% 
  group_by(group) %>% 
  summarise(mean_function = mean(n),
            median_function = median(n))
```
Вывод: В обеих группа пользователи в среднем делают одинаковое кол-во действий ---- медианно 4 в каждой группе.

### Действительно ли firstOpen -- это первое действие

Для проверки этого, мы по каждому пользователю отфильтруем самое первое действие
```{r}
action %>% 
  group_by(uid) %>% 
  filter(ts == min(ts)) %>% 
  ungroup() %>% 
  count(group, action)
```
Вывод: В каждой группе firstOpen, это первое действие

### Есть ли пользователи, которые попали в обе группы?

В рамках одного эксперимента, пользователь должен быть однозначно отнесён к одной из групп. 
Наличие его в двух группах одновременно может исказить результаты тестирования.
Например, у пользователя могла сформироваться привычка, или он провзаимодействует с уже знакомым элементом.
```{r}
action %>% 
  distinct(group, uid) %>% 
  count(uid) %>% 
  filter(n != 1)
```
Вывод: в эксперименте все пользователи отнесены к какой-то одной группе.

### Распределение времени до первого действия по группам

```{r}
action_with_metric %>% 
  ggplot(aes(group, time_to_action)) +
  geom_boxplot() +
    labs(
    title = "Boxplot для времени до первого действия по группам",
    x = "группа",
    y = "время до первого действия, мин."
  ) +
  coord_flip()
```

По boxplot можно сказать, что распределения похожи по характеру между собой. Имеют левую ассиметрию, с некоторым количеством выбросов справа. Посмотрим на гистограммы:

```{r}
action_with_metric %>% 
  ggplot(aes(time_to_action)) +
  geom_histogram(bins = 50) +
  facet_wrap(~group, nrow = 2) +
  labs(
    title = "Гистограмма распределения времени до первого действия по группам",
    x = "группа",
    y = "время до первого действия, мин."
  )
```

Распределение асиметричное, близкое по характеру к геометрическому. Отдалённо похоже на распределение хи-квадрат с небольшим кол-вом степеней свободы.

```{r}
action_with_metric %>% 
  mutate(time_to_action = as.numeric(time_to_action),
         time_to_action = log10(time_to_action)) %>% 
  ggplot(aes(time_to_action)) +
  geom_histogram(bins = 200) +
  facet_wrap(~group, nrow = 2) +
    labs(
    title = "Логарифм распределения времени до первого действия по группам",
    x = "группа",
    y = "время до первого действия, мин."
  )
```

Вывод: Распределение асиметричное, явно не нормальное, близкое к геометрическому.


### Проверка на нормальность логарифма распределения

Логарифм распределения имеет ярко выраженную правую ассиметрию. Тем не менее мы применим классические тесты на нормальность, чтобы убедиться в том, что распреление логарифма не является нормальным.

#### QQ-plot

```{r}
action_with_metric %>% 
  mutate(time_to_action = as.numeric(time_to_action),
         time_to_action = log10(time_to_action)) %>% 
  ggplot(aes(sample = time_to_action)) +
  stat_qq(alpha = 0.3) +
  stat_qq_line(col = "red") +
  facet_wrap(~group, nrow = 2) +
  labs(
    title = "QQ-plot логарифа распределения времени до первого действия"
  )
```

Чем ближе к красной прямой точки, тем более «нормальное» распределение. В нашем случае, очевидно, что распределение в обоих случаях не носит нормальный характер

#### Тест Калмогорова-Смирнова на нормальность

Воспользуемся тестом Калмогорова-Смирнова, уровень значимости определим 0.05.

Проверяется нулевая гипотеза о том, что выборка (Old и New по отдельности) подчиняется нормальному распределению.

```{r}

new_ks_test <- action_with_metric %>% 
  mutate(time_to_action = as.numeric(time_to_action),
         time_to_action = log10(time_to_action)) %>% 
  filter(group == "New") %>% 
  select(time_to_action)

old_ks_test <- action_with_metric %>% 
  mutate(time_to_action = as.numeric(time_to_action),
         time_to_action = log10(time_to_action)) %>% 
  filter(group == "Old") %>% 
  select(time_to_action)


ks.test(new_ks_test$time_to_action, 'pnorm')
ks.test(old_ks_test$time_to_action, 'pnorm')

```

p-value в обоих случаях много меньше заданного уровня значимости -- мы отвергаем нулевую гипотезу. У нас есть достаточно оснований, чтобы сказать, что логарифмированные данные выборок (Old и New по отдельности) не имеют нормального распределения.


## Анализ результатов

На основе проведённого EDA мы:

  * исключим последнего пользователя из группы Old, для уравнивания групп
  * для сравнения групп данных, выберем непараметрический тест, потому что данные распределены не нормально

### Подготовка данных для анализа
  
```{r}
# поиск последнего пользователя в группе
last_user <-  action_with_metric %>% 
  filter(group == "Old") %>% 
  filter(action1 == max(action1))

last_user

# фильтрация пользователя
action_with_metric <- action_with_metric %>% 
  filter(uid != last_user$uid)


```

Формирование дата фрейма для проверок
```{r}
action_for_tests <- action_with_metric %>% 
  select(group, time_to_action) %>% 
  mutate(time_to_action = as.numeric(time_to_action)) %>% 
  pivot_wider(
    values_fn = list,
    names_from = group,
    values_from = time_to_action
  ) %>% 
  unnest(c(New, Old))

action_for_tests
```

### Выбор уровня значимости

Для выявления значимых отклонений будет достаточен уровень значимости \alpha = 0.05

### Выбор теста для сравнения выборок

Выше показано, что распределения обеих выборок не является нормальными. Соответственно большинство параметрических тестов нам не подходит. 
Проверим данные и самих себя на нескольких непараметрических тестах 

  * Тест Манна-Уитни о равенстве медиан
  * Тест Краскелл-Уоллиса о равенства медиан

Этот тест представляет собой альтернативу t-критерию без распределения и используется для проверки гипотезы о том, что распределения в двух группах имеют одинаковую медиану.

Хорошей практикой при явно скошенном распределении является проверка непараметрическим тестом исходных данных. И затем сравнение результатов с тестом логарифмированных данных t-тестом.

#### Тест Манна-Уитни 

Двусторонний тест:
```{r}
wilcox.test(action_for_tests$Old, 
            action_for_tests$New, 
            alternative = "two.sided")
```

Значение `p-value = 0.07794` что хоть и близко, но больше заданного уровня значимости. 

Вывод: На основании теста Манна-Уитни о равенстве медиан в двух группах, у нас нет оснований отвергать нулевую гипотезу. 


#### Тест Краскела-Уоллиса


```{r}
kruskal.test(action_for_tests$Old, 
             action_for_tests$New)
```

Значение `p-value = 0.4273`

Вывод: На основании теста Краскела-Уоллиса о равенстве медиан в двух группах, у нас нет оснований отвергать нулевую гипотезу.

#### T-test для логарифмов распределения

```{r}
t.test(log10(action_for_tests$Old), 
       log10(action_for_tests$New),
       alternative = "two.sided")
```

Значение `p-value = 0.1147`

Вывод: На основании t-теста, у нас нет основания отвергать нулевую гипотезу.

## Вывод по эксперименту 2

По итогам трёх проведённых тестов: непараметрического Манна-Уитни, непараметрического Краскела-Уоллиса, а так же t-теста; у нас ни по одному из тестов нет оснований отвергать нулевую гипотезу.

Следовательно, по результатам `эксперимента 2` мы приходим к выводу, что перемена мест `function1` и `function2` не дала статистически значимых изменений. 

Поэтому предлагается оставить вариант, показываемый группе Old.

