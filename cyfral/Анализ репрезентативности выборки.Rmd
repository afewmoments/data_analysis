---
editor_options:
  chunk_output_type: console
output:
  html_document: default
  pdf_document: default
  word_document: default
---


# Задача

Расчитать объём репрезентативной выборки для рассылки смс для проекта "Обратная связь"

# Условия 

После исполнениях квартирных заявок необходимо производить обзвон клиентов для опроса удовлетворённости оказанными услугами.

Если делать это по всем заявкам, то выходит очень дорого.

```{r, include=FALSE}
library(tidyverse)
# install.packages("gamlss")
# install.packages("foreach")
library(foreach)
```

## Результаты смс-опроса

В ходе тестирования проекта были получены следующие результаты

```{r, include=FALSE}
x_real <- c(rep(1, 11), rep(2, 3), rep(3, 2), rep(4, 2), rep(5, 44))
sd(x_real)
mean(x_real)
summary(x_real)
```

```{r, warning=FALSE}
as.tibble(x_real) %>%
ggplot(aes(x_real)) + 
  geom_bar() +
  labs(
    x = "Оценка",
    y = "Кол-во оценок",
    title = "Распределение оценок, при проверке пилота",
    subtitle = "Всего получено 62 оценки в период с 10-го по 15-ое января 2019 года"
  )
```


# Генерация генеральной совокупности

Так как распределение оценок статистически не нормальный характер распределения, не имеет смысл вести подсчёт в 5-ти бальной системе.

В дальнейших расчётах для генеральной совокупности, пяти бальная шкала переводилась в бинарную систему оценок. 
Принималось что оценки 4 и 5 --- это 1, остальные --- это 0.

Таким образом предлагается считать коэффициент удовлетворённости (`Service Level(SL)`) как отношение положительных оценок к количеству всех полученных оценок

$$SL = \frac{N_{positive}}{N_{positive}+N_{negativ}}\times100\% $$

Генеральная совокупность --- это такая гипотетическая выборка, в которой смс были отправлены на все квартирные заявки и все абоненты оценили услуги компании.

Так как нет возможности получить данные о всех оценках, то распределение генеральной совокупности было сгенерировано методом экстраполяции полученных данных. 

То есть создана выборка с точно таким же распределением оценок, но в количестве равном ежемесячному среднему количеству квартирных заявок.

Cреднемесячный объём квартирных заявок в БЕ брался из исследования Ю. Захаровой.

`![Ежемесячный объём квартирных заявок в БЕ](1.PNG)`

# Как проводился расчёт

Из генеральной совокупности случайным образом извлекалось случайное колиество элементов.

Количество элементов --- это количество получаемых в ответ СМС.

В теории чем выше количество повторов (извлекаемых выборок), тем выше точность.
В исследовании извлечение выборок производилось 20 раз --- округлённо по числу БЕ.

В каждой выборке рассчитывалось среднее значение и 95% вероятность попасть в доверительный интервал.

Для исследования помимо полученной генеральной совокупности, было сгенерировано ещё три выборки с коэфициентом удовлетворённости равным соответственно 80%, 85%, 90%.

Эти коэффициенты отражают желаемое количество получаемых положительных отзывов.

```{r, include=FALSE}
repeater <- function(data, sms, vector) {
  t <- foreach(i = vector, .combine = "c") %do%
    mean((sample(data, sms, replace = TRUE)))
  table <- tibble(
    sms = sms,
    mean = mean(t),
    sd = sd(t),
    ymax = mean(t) + 1.96*sd(t)/sqrt(length(vector)),
    ymin = mean(t) - 1.96*sd(t)/sqrt(length(vector))
  )
  return(table)
}

feedback <- function(data, sms, vector){
  table <- tibble(
    sms = integer(),
    mean = integer(),
    ymax = integer(),
    ymin = integer(),
    sd = integer())
  for (i in sms) {
   t <- repeater(data, i, vector)
    table <- add_row(table,
            sms = t$sms,
            mean = t$mean,
            sd = t$sd,
            ymax = t$ymax,
            ymin = t$ymin)
  }
  return(table)
}
```

# Service Level 71% --- по полученным данным проекта рассылки смс

```{r}
x_test_71 <- c(rep(0, 23907), rep(1, 60000))
mean(x_test_71)

k_71 <- feedback(x_test_71, seq(10, 150, 10), 1:20)

ggplot(k_71, aes(factor(sms), mean)) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), width = 0.1, lwd = 0.5) +
  geom_point(shape = 21, size = 3, fill = 'white') +
  geom_hline(yintercept = 0.7150774, color ="red") +
  labs(x = "Кол-во полученных ответов по смс",
       y = "Коэффициент сервисного обслуживания",
       title ="Распределение оценки, в зависимости от кол-ва получаемых смс",
       subtitle = "Уровень SL = 71% показан красной линией \nКоличество выборок (т.е. БЕ) = 20 \nДоверительный интервал = 95%") +
  scale_y_continuous(labels = function(x) paste0(x*100, "%"))
```


# Service Level 80% 

```{r}
x_test_80 <- c(rep(0, 15000), rep(1, 60000))
mean(x_test_80)

k_80 <- feedback(x_test_80, seq(10, 150, 10), 1:20)

ggplot(k_80, aes(factor(sms), mean)) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), width = 0.1, lwd = 0.5) +
  geom_point(shape = 21, size = 3, fill = 'white') +
  geom_hline(yintercept = 0.8, color ="red") +
  labs(x = "Кол-во полученных ответов по смс",
       y = "Коэффициент сервисного обслуживания",
       title ="Распределение оценки, в зависимости от кол-ва получаемых смс",
       subtitle = "Уровень SL = 80% показан красной линией \nКоличество выборок (т.е. БЕ) = 20 \nДоверительный интервал = 95%") +
  scale_y_continuous(labels = function(x) paste0(x*100, "%"))
```

# Service Level 85%

```{r}
x_test_85 <- c(rep(0, 61764), rep(1, 350000))
mean(x_test_85)

k_85 <- feedback(x_test_85, seq(10, 150, 10), 1:20)

ggplot(k_85, aes(factor(sms), mean)) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), width = 0.1, lwd = 0.5) +
  geom_point(shape = 21, size = 3, fill = 'white') +
  geom_hline(yintercept = 0.85, color ="red") +
  labs(x = "Кол-во полученных ответов по смс",
       y = "Коэффициент сервисного обслуживания",
       title ="Распределение оценки, в зависимости от кол-ва получаемых смс",
       subtitle = "Уровень SL = 85% показан красной линией \nКоличество выборок (т.е. БЕ) \nДоверительный интервал = 95%") +
  scale_y_continuous(labels = function(x) paste0(x*100, "%"))
```

# Service Level 90%

```{r}
x_test_90 <- c(rep(0, 6666), rep(1, 60000))
mean(x_test_90)

k_90 <- feedback(x_test_90, seq(10, 150, 10), 1:20)

ggplot(k_90, aes(factor(sms), mean)) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), width = 0.1, lwd = 0.5) +
  geom_point(shape = 21, size = 3, fill = 'white') +
  geom_hline(yintercept = 0.900009, color ="red") +
  labs(x = "Кол-во полученных ответов по смс",
       y = "Коэффициент сервисного обслуживания",
       title ="Распределение оценки, в зависимости от кол-ва получаемых смс",
       subtitle = "Уровень SL = 90% показан красной линией \nКоличество выборок (т.е. БЕ) \nДоверительный интервал = 95%") +
  scale_y_continuous(labels = function(x) paste0(x*100, "%"))
```


# Выводы

```{r, include= FALSE}
# Формирование выборки
k_71 <- k_71 %>%
  mutate(id = "k_71")

k_80 <- k_80 %>%
  mutate(id = "k_80")

k_85 <- k_85 %>%
  mutate(id = "k_85")

k_90 <- k_90 %>%
  mutate(id = "k_90")

total <- rbind(k_71, k_80, k_85, k_90)
```

Во всех полученных выборках (70, 80, 85, 90) при увеличении количества оценок закономерно улучшается точность оценки.
На уровне в 70 полученных смс --- ошибка становится не столь критичной.
Диапазон, в котором может изменяться оценка остаётся в пределах 5% погрешности:

```{r}
ggplot(total, aes(factor(sms), mean)) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax, color = id), width = 0.5, lwd = 0.1) +
  geom_point(shape = 21, size = 3, fill = 'white') +
  geom_hline(yintercept = 0.900009, color ="violet") +
  geom_hline(yintercept = 0.85, color ="blue") +
  geom_hline(yintercept = 0.80, color ="orange") +
  geom_hline(yintercept = 0.7150774, color ="red") +
  labs(x = "Кол-во полученных ответов по смс",
       y = "Коэффициент сервисного обслуживания",
       title ="Распределение оценки, в зависимости от кол-ва получаемых смс",
       subtitle = "Количество выборок (т.е. БЕ) = 20 \nДоверительный интервал = 95%") +
  scale_y_continuous(labels = function(x) paste0(x*100, "%"))
```


```{r}
ggplot(total, aes(factor(sms), mean)) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax, color = id), width = 0.5, lwd = 0.1) +
  geom_point(shape = 21, size = 3, fill = 'white') +
  facet_wrap(~id, nrow = 1) +
  labs(x = "Кол-во полученных ответов по смс",
       y = "Коэффициент сервисного обслуживания",
       title ="Распределение оценки, в зависимости от кол-ва получаемых смс",
       subtitle = "Количество выборок (т.е. БЕ) = 20 \nДоверительный интервал = 95%") +
  scale_y_continuous(labels = function(x) paste0(x*100, "%"))
```


На следующем графике наглядно видно, что точность (т.е. величина ошибки) существенно улучшается до количества 70 отправленных смс. А начиная от 70 вплоть до 150 полученных смс оценка улучшается несущественно.

```{r}
ggplot(total, aes(factor(sms), (ymax-ymin))) + 
  geom_col(aes(fill = id)) +
  labs(x = "Кол-во полученных ответов по смс",
       y = "Протяженность доверительного интервала",
       title ="Изменение ошибки вычисления в зависимости\nот количества полученных смс",
       subtitle = "Количество выборок (т.е. БЕ) = 20 \nДоверительный интервал = 95%")
```

__Рекомендуемое количество получаемых смс на одну БЕ в месяц --- не менее 70 смс__
